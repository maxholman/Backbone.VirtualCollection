!function(t,i){"function"==typeof define&&define.amd?define(["backbone","underscore"],i):"object"==typeof exports?module.exports=i(require("backbone"),require("underscore")):t.VirtualCollection=i(t.Backbone,t._)}(this,function(t,i){function e(t,i,e,n){for(var s=0,o=t.length;o>s;){var r=s+o>>>1;e.call(n,i,t[r])>0?s=r+1:o=r}return s}var n=t.VirtualCollection=t.Collection.extend({constructor:function(t,i){i=i||{},this.collection=t,void 0!==i.comparator&&(this.comparator=i.comparator),i.close_with&&this.bindLifecycle(i.close_with,"close"),i.destroy_with&&this.bindLifecycle(i.destroy_with,"destroy"),t.model&&(this.model=t.model),this.accepts=n.buildFilter(i.filter),this._rebuildIndex(),this.listenTo(this.collection,"add",this._onAdd),this.listenTo(this.collection,"remove",this._onRemove),this.listenTo(this.collection,"change",this._onChange),this.listenTo(this.collection,"reset",this._onReset),this.listenTo(this.collection,"filter",this._onFilter),this.listenTo(this.collection,"sort",this._onSort),this.listenTo(this.collection,"update",this._onUpdate),this._proxyParentEvents(["sync","request","error"]),this.initialize.apply(this,arguments)},bindLifecycle:function(t,i){this.listenTo(t,i,this.stopListening)},updateFilter:function(t){return this.accepts=n.buildFilter(t),this._rebuildIndex(),this.trigger("filter",this,t),this.trigger("reset",this,t),this},_rebuildIndex:function(){i.invoke(this.models,"off","all",this._onAllEvent,this),this._reset(),this.collection.each(i.bind(function(t,i){this.accepts(t,i)&&(this.listenTo(t,"all",this._onAllEvent),this.models.push(t),this._byId[t.cid]=t,t.id&&(this._byId[t.id]=t))},this)),this.length=this.models.length,this.comparator&&this.sort({silent:!0})},orderViaParent:function(t){this.models=this.collection.filter(function(t){return void 0!==this._byId[t.cid]},this),t.silent||this.trigger("sort",this,t)},_onSort:function(t,i){void 0===this.comparator&&this.orderViaParent(i)},_proxyParentEvents:function(t){i.each(t,i.bind(function(t){this.listenTo(this.collection,t,i.partial(this.trigger,t))},this))},_onUpdate:function(t,i){this.trigger("update",this,i)},_onAdd:function(t,i,e){var n=this.get(t);!n&&this.accepts(t,e.index)&&(this._indexAdd(t),this.listenTo(t,"all",this._onAllEvent),this.trigger("add",t,this,e))},_onRemove:function(t,e,n){if(this.get(t)){var s=this._indexRemove(t),o=i.clone(n);o.index=s,t.off("all",this._onAllEvent,this),this.trigger("remove",t,this,o)}},_onChange:function(t,e){if(t&&e){var n=this.get(t);if(this.accepts(t,e.index))n?(!this._byId[t.id]&&t.id&&(this._byId[t.id]=t),this.trigger("change",t,this,e)):(this._indexAdd(t),this.trigger("add",t,this,e));else if(n){var s=this._indexRemove(t),o=i.clone(e);o.index=s,this.trigger("remove",t,this,o)}}},_onReset:function(t,i){this._rebuildIndex(),this.trigger("reset",this,i)},_onFilter:function(t,i){this._rebuildIndex(),this.trigger("filter",this,i)},sortedIndex:function(t,n,s){var o=i.isFunction(n)?n:function(t){return t.get(n)};return 1==o.length?i.sortedIndex(this.models,t,o,s):e(this.models,t,o,s)},_indexAdd:function(t){if(!this.get(t)){var i;i=this.comparator?this.sortedIndex(t,this.comparator,this):void 0===this.comparator?this.sortedIndex(t,function(t){return this.collection.indexOf(t)},this):this.length,this.models.splice(i,0,t),this._byId[t.cid]=t,t.id&&(this._byId[t.id]=t),this.length+=1}},_indexRemove:function(t){t.off("all",this._onAllEvent,this);var i=this.indexOf(t);return-1===i?i:(this.models.splice(i,1),delete this._byId[t.cid],t.id&&delete this._byId[t.id],this.length-=1,i)},_onAllEvent:function(t){var e=["add","remove","change","reset","sort"];i.contains(e,t)||this.trigger.apply(this,arguments)},clone:function(){return new this.collection.constructor(this.models)}},{buildFilter:function(t){return t?i.isFunction(t)?t:t.constructor===Object?function(e){return i.every(i.keys(t),function(i){return e.get(i)===t[i]})}:void 0:function(){return!0}}});return i.each(["add","remove","set","reset","push","pop","unshift","shift","slice","sync","fetch","url"],function(t){n.prototype[t]=function(){return i.isFunction(this.collection[t])?this.collection[t].apply(this.collection,arguments):this.collection[t]}}),i.extend(n.prototype,t.Events),n});